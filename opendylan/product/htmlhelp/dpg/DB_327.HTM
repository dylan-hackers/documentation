<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<!-- Generated by Harlequin WebMaker 3.0.2 ( 8-May-1997 experimental) -->
<HEAD>
<LINK REL=TOP HREF="DB_1.HTM">
<LINK REL=UP HREF="DB_326.HTM">
<LINK REL=PREV HREF="DB_326.HTM">
<LINK REL=NEXT HREF="DB_328.HTM">
<TITLE>20.4.1   Protected objects</TITLE>
<META NAME=GENERATOR CONTENT="Harlequin WebMaker 3.0.2 ( 8-May-1997 experimental)">
</HEAD>
<BODY BGCOLOR="#FFFFFF">

<DIV>
<A NAME=HEADING327></A>

<DIV>
<P><A HREF="DB_328.HTM"><IMG ALIGN=BOTTOM SRC=next.gif ALT=Next BORDER=0></A> <A HREF="DB_326.HTM"><IMG ALIGN=BOTTOM SRC=prev.gif ALT=Previous BORDER=0></A> <A HREF="DB_1.HTM"><IMG ALIGN=BOTTOM SRC=top.gif ALT=Top BORDER=0></A> <A HREF="DB_2.HTM"><IMG ALIGN=BOTTOM SRC=content.gif ALT=Contents BORDER=0></A> <A HREF="DB_349.HTM"><IMG ALIGN=BOTTOM SRC=index.gif ALT=Index BORDER=0></A></P>

</DIV>
<A NAME=HEADING327-0></A>
<H1>20.4.1   Protected objects</H1>
<P> Suppose that you want to design a class of objects that could be accessed only when a lock for that object is granted. You might use instances of such a class to avoid conflicting concurrent access in a multithreaded implementation of Dylan, or you might use instances of such a class to represent files or other operating-<BR>system objects that might be accessed reliably by only one process at a time. Let's assume that the <CODE>&lt;lock&gt;</CODE> class and the <CODE>get-lock</CODE> and <CODE>release-lock</CODE> functions are supplied by an external library. The <CODE>get-lock</CODE> function atomically obtains the lock if that lock is available; otherwise, it waits until the lock becomes free, and then obtains the lock. The <CODE>release-lock</CODE> function frees the lock so that some other process can acquire the lock. Given this locking library, how would we define the following? </P>
<UL>
<LI><P>A class that represents a protected object </P>
<LI><P>A <CODE>call-using-lock</CODE> function, which acquires a lock associated with a protected object, calls an arbitrary function, and then releases the lock</P>
</UL>
<P> We could define the class as follows:</P>
<PRE>
define abstract class &lt;protected-object&gt; (&lt;object&gt;)
  slot object-lock :: &lt;lock&gt; = make(&lt;lock&gt;);
end class &lt;protected-object&gt;;
</PRE>
<P> Each subclass of <CODE>&lt;protected-object&gt;</CODE> would inherit an <CODE>object-lock</CODE> slot. The lock instance stored in this slot must be acquired prior to any operation on the protected object, and released when the operation is complete. One naive way to implement <CODE>call-using-lock</CODE> would be as follows:</P>
<PRE>
define method call-using-lock 
    (object :: &lt;protected-object&gt;, function :: &lt;function&gt;, #rest args)
 =&gt; (#rest results)
  get-lock(object.object-lock);
  apply(function, object, args);
  release-lock(object.object-lock);
end method call-using-lock;
</PRE>
<P> The approach in the preceding example has two serious problems. First, <CODE>call-using-lock</CODE> does not return the values returned by calling <CODE>function</CODE>. Second, if <CODE>function </CODE>executes a nonlocal exit past <CODE>call-using-lock</CODE>, the <CODE>release-lock</CODE> call will never be executed, and after that point no process will be able to acquire the lock for the protected object. Thus, subsequent attempts to use the protected object will wait forever, because the lock was not properly released. We could add a handler that would release the lock if any condition is signaled, but that might be incorrect, because certain conditions might be handled within the dynamic scope of <CODE>function</CODE>, and might never perform a nonlocal exit past <CODE>call-using-lock</CODE>. Thus, the lock might be released prematurely, possibly causing the integrity of the protected object to be violated. Also, calling an exit procedure performs a nonlocal exit without signaling a condition at all. </P>
<P>To solve exactly this sort of problem, Dylan provides the <A NAME=MARKER-2-848></A><CODE>cleanup</CODE> clause of <CODE>block</CODE>. Code within the body of a <CODE>cleanup</CODE> clause is guaranteed to be executed before the <CODE>block</CODE> is exited, even if it is a nonlocal exit that causes the <CODE>block</CODE> to <BR>terminate. The value of this <CODE>block</CODE> will be the result of calling <CODE>function</CODE>. The <CODE>cleanup</CODE> clause does not affect what the <CODE>block</CODE> returns. </P>
<PRE>
define method call-using-lock 
    (object :: &lt;protected-object&gt;, function :: &lt;function&gt;, #rest args)
 =&gt; (#rest results)
  block ()
    get-lock(object.object-lock);
    apply(function, object, args);
  cleanup
    release-lock(object.object-lock);
  end block;
end method call-using-lock;
</PRE>
<P> The <CODE>cleanup</CODE> clause of <CODE>block</CODE> provides a powerful tool for ensuring the integrity of applications that use nonlocal exits.</P>

</DIV>

<DIV>

<DIV>

<!-- TOC -->

</DIV>

<HR>
<ADDRESS>Dylan Programming - 9 Apr 1999</ADDRESS>
<P><A HREF="DB_328.HTM"><IMG ALIGN=BOTTOM SRC=next.gif ALT=Next BORDER=0></A> <A HREF="DB_326.HTM"><IMG ALIGN=BOTTOM SRC=prev.gif ALT=Previous BORDER=0></A> <A HREF="DB_1.HTM"><IMG ALIGN=BOTTOM SRC=top.gif ALT=Top BORDER=0></A> <A HREF="DB_2.HTM"><IMG ALIGN=BOTTOM SRC=content.gif ALT=Contents BORDER=0></A> <A HREF="DB_349.HTM"><IMG ALIGN=BOTTOM SRC=index.gif ALT=Index BORDER=0></A></P>
<P>N Feinberg/S E Keene/R Mathews/P Tucker Withington, DYLAN PROGRAMMING, (c) 1997 Harlequin Inc. Reproduced by permission of Addison-Wesley Longman Publishing Company, Inc.  All rights reserved. No further copying, downloading or transmitting of this material is allowed without the prior written permission of the publisher.</P>

</DIV>
</BODY>
</HTML>
