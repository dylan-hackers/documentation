<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML Experimental 19960712//EN">
<HTML>
<!-- Generated by Harlequin WebMaker 3.0.2 ( 8-May-1997 experimental) -->
<HEAD>
<LINK REL=TOP HREF="drm_1.htm">
<LINK REL=UP HREF="drm_76.htm">
<LINK REL=PREV HREF="drm_84.htm">
<LINK REL=NEXT HREF="drm_86.htm">
<LINK TITLE="WebMaker generated style" REL=stylesheet HREF=drm.css TYPE="text/css">
<TITLE> Hygiene</TITLE>
<META NAME=GENERATOR CONTENT="Harlequin WebMaker 3.0.2 ( 8-May-1997 experimental)">
</HEAD>
<BODY BGCOLOR="#FEFEF2" TEXT="#000000" LINK="#0000FF" VLINK="#800080" ALINK="#FF0000">

<DIV CLASS=WM-DIV-BODY>
<A NAME=HEADING85></A>

<DIV CLASS=WM-DIV-HEADERS>
<P CLASS=HEADER><A HREF="drm_86.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=next.gif CLASS=HEADER></A> <A HREF="drm_84.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=prev.gif CLASS=HEADER></A> <A HREF="drm_76.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=up.gif CLASS=HEADER></A> <A HREF="drm_1.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=top.gif CLASS=HEADER></A> <A HREF="drm_2.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=content.gif CLASS=HEADER></A> <A HREF="drm_127.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=index.gif CLASS=HEADER></A></P>
<P CLASS=HEADER>10 Macros</P>

</DIV>
<A NAME=HEADING85-0></A>
<A NAME=UID-Macros-1884></A>
<H1 CLASS=H1.Heading1> <A NAME=MARKER-9-1268></A>Hygiene</H1>
<P CLASS=T1.Text1><A NAME=MARKER-2-1269></A>Dylan macros are always <B CLASS="bold T1.Text1">hygienic</B>. The basic idea is that each <A NAME=MARKER-2-1270></A>named value reference in a macro expansion means the same thing as it meant at the place in the original source code from which it was copied into the macro expansion. This is true whether that place was in the macro definition or in the macro call. Because a macro expansion can include macro calls that need further expansion, named value references in one final expansion can come from several different macro definitions and can come from several different macro calls, either to different macros or--in the case of recursion--distinct calls to the same macro.</P>
<P CLASS=T1.Text1>(Sometimes the property that variable references copied from a macro call mean the same thing in the expansion is called "hygiene" and the property that variable references copied from a macro definition mean the same thing in the expansion is called "<A NAME=MARKER-2-1271></A>referential transparency."  We include both properties in the term "hygiene.")</P>
<P CLASS=T1.Text1>Specifically, a macro can bind <A NAME=MARKER-2-1272></A>temporary variables in its expansion without the risk of accidentally capturing references in the macro call to another binding with the same name. Furthermore, a macro can reference module bindings in its expansion without the risk of those references accidentally being <A NAME=MARKER-2-1273></A>captured by bindings of other variables with the same name that surround the macro call. A macro can reference module bindings in its expansion without worrying that the intended bindings might have different names in a module where the macro is called.</P>
<P CLASS=T1.Text1>One way to implement this is for each <I CLASS="Parameter T1.Text1">template-element</I> that is a <EM CLASS=T1.Text1>name</EM>, <EM CLASS=T1.Text1>unary-operator</EM>, or <EM CLASS=T1.Text1>binary-operator</EM> to be replaced in the macro expansion by a special token that plays the same grammatical role as the <EM CLASS=T1.Text1>name</EM>, <EM CLASS=T1.Text1>unary-operator</EM>, or <EM CLASS=T1.Text1>binary-operator</EM> but remembers three pieces of information:</P>
<UL CLASS=B1.Bullet1>
<LI CLASS=B1.Bullet1>The original <EM CLASS=B1.Bullet1>name</EM>. For an operator, this is the name listed in <A HREF="drm_31.htm#MARKER-9-427" CLASS=B1.Bullet1>Table 4-1 on page 37</A>.
<LI CLASS=B1.Bullet1>The lexical context where the macro was defined, which is just a module since macro definitions are only allowed at top level, not inside of bindings.
<LI CLASS=B1.Bullet1>The specific macro call occurrence. This could be an integer that is incremented each time a macro expansion occurs.
<P CLASS=T1.Text1>In general one cannot know until all macros are expanded whether a <EM CLASS=T1.Text1>name</EM> is a bound variable reference, a module binding reference, a variable that is being bound, or something that is not a binding name at all, such as a definition <I CLASS="Parameter T1.Text1">modifier</I> or an intermediate word. Similarly, one cannot know until all macros are expanded whether a <EM CLASS=T1.Text1>unary-operator</EM> or <EM CLASS=T1.Text1>binary-operator</EM> refers to a local binding or a module binding. Thus the information for each of those cases is retained in the special token. A named value reference and a binding connect if and only if the original <EM CLASS=T1.Text1>names</EM> and the specific macro call occurrences are both the same. (In that case, the lexical contexts will also be the same, but this need not be checked.)  A named value reference and a binding never connect if one originated in a template and the other originated in a macro call. </P>
<P CLASS=T1.Text1><A NAME=MARKER-2-1274></A>References in a macro expansion to <CODE CLASS="cv T1.Text1">element</CODE> or <CODE CLASS="cv T1.Text1">aref</CODE> created by using element reference syntax  must receive similar treatment so the <EM CLASS=T1.Text1>name</EM> <CODE CLASS="cv T1.Text1">element</CODE> or <CODE CLASS="cv T1.Text1">aref</CODE> gets looked up  in the environment of the macro definition, not the environment of the  macro call.</P>
<P CLASS=T1.Text1>For purposes of hygiene, a <I CLASS="Parameter T1.Text1">pattern-keyword default</I> is treated like part of a template, even though it is actually part of a pattern.</P>
<P CLASS=T1.Text1><A NAME=MARKER-2-1275></A>The mapping from getters to setters done by the <CODE CLASS="cv T1.Text1">:=</CODE> operator is hygienic. In all cases the setter name is looked up in the same lexical context and macro call occurrence as the getter name.</P>
</UL>
<A NAME=HEADING85-12></A>
<A NAME=UID-Macros-1902></A>
<H2 CLASS=H2.Heading2> Intentional Hygiene Violation</H2>
<P CLASS=T1.Text1><A NAME=MARKER-2-1276></A>Sometimes it is necessary for a macro to violate the hygienic property, for example to include in a macro expansion a named value reference to be executed in the lexical context where the macro was called, not the lexical context where the macro was defined. Another example is creating a local binding in a macro expansion that will be visible to the body of the macro. This feature should be used sparingly, as it can be confusing to users of the macro, but sometimes it is indispensable.</P>
<P CLASS=T1.Text1>The construct <CODE CLASS="cv T1.Text1">?=<I CLASS="cv T1.Text1">  <EM CLASS="cv T1.Text1">name</EM></I></CODE> in a template inserts into the expansion a reference to <EM CLASS=T1.Text1>name</EM>, in the lexical context where the macro was called. It is as if <EM CLASS=T1.Text1>name</EM> came from the macro call rather than from the template.<A NAME=MARKER-2-1277></A></P>
<A NAME=HEADING85-15></A>
<A NAME=UID-Macros-1906></A>
<H2 CLASS=H2.Heading2> Hygiene Versus Module Encapsulation</H2>
<P CLASS=T1.Text1><A NAME=MARKER-2-1278></A>A named value reference in a macro expansion that was produced by a <I CLASS="Parameter T1.Text1">template-element</I> that is a <EM CLASS=T1.Text1>name</EM>, <EM CLASS=T1.Text1>unary-operator</EM>, <EM CLASS=T1.Text1>binary-operator</EM>, or <CODE CLASS="cv T1.Text1">[ <I CLASS="Parameter cv T1.Text1">template<EM CLASS="Subscript Parameter cv T1.Text1">opt ]</EM></I></CODE> and that does not refer to a local binding created by the macro expansion must have the same meaning as would a named value reference with the same name adjacent to the macro definition. This is true even if the macro call is in a different module or a different library from the one in which the macro definition occurs, even if the binding is not exported. </P>
<P CLASS=T1.Text1>This allows exported macros to make use of private bindings without requiring these bindings to be exported for general use. The module that calls the macro does not need to import the private bindings used by the expansion.</P>
<P CLASS=T1.Text1>If one of the following template-element sequences appears in the right-hand side of a rewrite rule, it may introduce named value references to the indicated name in an expansion of the macro. If such a named value reference does not refer to a local binding created by the macro expansion then it must have the same meaning as would a named value reference with the same name adjacent to the macro definition.</P>
<UL CLASS=B1.Bullet1>
<LI CLASS=B1.Bullet1><I CLASS="Parameter B1.Bullet1">variable-name<EM CLASS="Parameter B1.Bullet1"><BR><BR></EM></I>Reference to <I CLASS="Parameter B1.Bullet1">variable-name</I>
<LI CLASS=B1.Bullet1><I CLASS="Parameter B1.Bullet1">getter-name</I> <CODE CLASS="cv B1.Bullet1">( <I CLASS="Parameter cv B1.Bullet1">template<EM CLASS="Subscript Parameter cv B1.Bullet1">opt  )</EM></I></CODE> <I CLASS="Parameter B1.Bullet1">assignment-operator<BR>assignment-operator-name<CODE CLASS="cv Parameter B1.Bullet1"> ( template<EM CLASS="Subscript cv Parameter B1.Bullet1">opt getter-name ( templateopt</EM></CODE></I> <CODE CLASS="cv B1.Bullet1">) )<BR><BR></CODE>Reference to <I CLASS="Parameter B1.Bullet1">getter-name<CODE CLASS="cv Parameter B1.Bullet1"> ## &quot;-setter&quot;</CODE></I>
<LI CLASS=B1.Bullet1><CODE CLASS="cv B1.Bullet1">[</CODE> <I CLASS="Parameter B1.Bullet1">template<EM CLASS="Subscript Parameter B1.Bullet1">opt<CODE CLASS="cv Subscript Parameter B1.Bullet1"> ] assignment-operator<BR>assignment-operator-name ( templateopt [ templateopt ] )<BR></CODE></EM></I><BR>Reference to either <CODE CLASS="cv B1.Bullet1">element-setter</CODE> and <CODE CLASS="cv B1.Bullet1">aref-setter</CODE>
<LI CLASS=B1.Bullet1><CODE CLASS="cv B1.Bullet1">. <I CLASS="Parameter cv B1.Bullet1">getter-name</I></CODE> <I CLASS="Parameter B1.Bullet1">assignment-operator<BR>assignment-operator-name<CODE CLASS="cv Parameter B1.Bullet1"> ( template<EM CLASS="Subscript cv Parameter B1.Bullet1">opt . getter-name )<BR></EM></CODE></I><BR>Reference to <I CLASS="Parameter B1.Bullet1">getter-name<CODE CLASS="cv Parameter B1.Bullet1"> ## &quot;-setter&quot;</CODE></I>
<LI CLASS=B1.Bullet1><CODE CLASS="cv B1.Bullet1">define <I CLASS="Parameter cv B1.Bullet1">definition-head<EM CLASS="Subscript Parameter cv B1.Bullet1">opt definer-name<BR></EM></I></CODE><BR>Reference to <I CLASS="Parameter B1.Bullet1">definer-name<CODE CLASS="cv Parameter B1.Bullet1"> ## &quot;-definer&quot;</CODE></I>
<P CLASS=T1.Text1>Items in the preceding template-element sequences have the following meanings:</P>
<UL CLASS=B2.Bullet2>
<LI CLASS=B2.Bullet2><I CLASS="Parameter B2.Bullet2"> assignment-operator-name</I> is a <EM CLASS=B2.Bullet2>name</EM>, and the value of the binding with that name (in the module containing the macro definition in which the template occurs) is the assignment macro that is the value of the binding named <CODE CLASS="cv B2.Bullet2">\:= </CODE>exported by the Dylan module of the Dylan library. 
<LI CLASS=B2.Bullet2> <I CLASS="Parameter B2.Bullet2">assignment-operator</I> is a binary-operator whose associated binding is an <I CLASS="Parameter B2.Bullet2">assignment-operator-name</I>.)
<LI CLASS=B2.Bullet2><I CLASS="Parameter B2.Bullet2">definer-name</I> is a <EM CLASS=B2.Bullet2>define-body-word</EM> or <EM CLASS=B2.Bullet2>define-list-word</EM>.
<LI CLASS=B2.Bullet2><I CLASS="Parameter B2.Bullet2">variable-name</I> and <I CLASS="Parameter B2.Bullet2">getter-name</I> are <EM CLASS=B2.Bullet2>name</EM>s.
<LI CLASS=B2.Bullet2><I CLASS="Parameter B2.Bullet2">template</I> is defined in <A HREF="drm_116.htm#MARKER-9-2090" CLASS=B2.Bullet2>Appendix A, "BNF,"</A> on <A HREF="drm_118.htm#MARKER-9-2121" CLASS=B2.Bullet2>page 429</A>.
<LI CLASS=B2.Bullet2><I CLASS="Parameter B2.Bullet2">definition-head</I> is defined in <A HREF="drm_116.htm#MARKER-9-2090" CLASS=B2.Bullet2>Appendix A, "BNF,"</A> on <A HREF="drm_118.htm#MARKER-9-2117" CLASS=B2.Bullet2>page 427</A>.
<LI CLASS=B2.Bullet2>The notation <I CLASS="Parameter B2.Bullet2">foo<CODE CLASS="cv Parameter B2.Bullet2"> ## &quot;string&quot;</CODE></I> indicates a new token composed of the text of <I CLASS="Parameter B2.Bullet2">foo</I> concatenated with the string.
<P CLASS=T1.Text1>Note that these template-element sequences can overlap in a template. For example <CODE CLASS="cv T1.Text1">{ foo (bar) := }</CODE> is a potential reference to <CODE CLASS="cv T1.Text1">foo</CODE>, to <CODE CLASS="cv T1.Text1">foo-setter</CODE>, and to <CODE CLASS="cv T1.Text1">bar</CODE>.</P>
<P CLASS=T1.Text1>Implementations must use some automatic mechanism for noting the bindings associated with the named value references in macro expansions produced by the template-element sequences described above, and must make such bindings available to any library where the macro is accessible. In general, the set of bindings that must be made available to other libraries cannot be computed precisely because the right-hand sides of rewrite rules are not fully parsed until after a macro is called and expanded, making it impossible to determine whether an occurrence of one of the described sequences of template elements will actually produce a named variable reference in the expansion. However, an upper bound on this set of bindings can be computed by assuming that all occurrences of the described template-element sequences might introduce the indicated named value reference if there is a binding for that name accessible from the module in which the macro definition appears.<A NAME=MARKER-2-1279></A><A NAME=MARKER-2-1280></A></P>
</UL>
</UL>

</DIV>

<DIV CLASS=WM-DIV-FOOTERS>

<DIV CLASS=WM-DIV-TOC>

<!-- TOC --><DL CLASS=FOOTER>
<DT CLASS=FOOTER><A REL=BELOW HREF="drm_85.htm#HEADING85-12" CLASS=FOOTER><B CLASS=FOOTER></B>Intentional Hygiene Violation</A>
<DD CLASS=FOOTER>
<DT CLASS=FOOTER><A REL=BELOW HREF="drm_85.htm#HEADING85-15" CLASS=FOOTER><B CLASS=FOOTER></B>Hygiene Versus Module Encapsulation</A>
<DD CLASS=FOOTER>
</DL>


</DIV>

<HR CLASS=FOOTER>
<ADDRESS CLASS=FOOTER>The Dylan Reference Manual - 7 Apr 1998</ADDRESS>
<P CLASS=FOOTER><A HREF="drm_86.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=next.gif CLASS=HEADER></A> <A HREF="drm_84.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=prev.gif CLASS=HEADER></A> <A HREF="drm_76.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=up.gif CLASS=HEADER></A> <A HREF="drm_1.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=top.gif CLASS=HEADER></A> <A HREF="drm_2.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=content.gif CLASS=HEADER></A> <A HREF="drm_127.htm" CLASS=HEADER><IMG ALIGN=BOTTOM BORDER=0 SRC=index.gif CLASS=HEADER></A></P>
<P CLASS=FOOTER>Copyright Apple Computer, Inc. 1996. Apple&#174; and the Apple logo are registered trademarks of Apple Computer, Inc. Used with permission. All Rights Reserved.</P>
<P CLASS=FOOTER>You can order a <A HREF="http://www.harlequin.com/products/ads/dylan/purchase.shtml" CLASS=FOOTER>bound copy</A> of this book from Harlequin.</P>
<P CLASS=FOOTER>Generated with <A HREF="http://www.harlequin.com/webmaker" CLASS=FOOTER>Harlequin WebMaker&#174;</A></P>

</DIV>
</BODY>
</HTML>
